<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff69b4">
    <title>StudyMaster - Gamificado</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            padding: 20px 10px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo h1 {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(255, 105, 180, 0.3);
        }

        /* Sistema de puntos gamificado */
        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(255, 154, 158, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #d63384;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6f42c1;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.lives {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
        }

        .lives-visual {
            font-size: 0.8rem;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* √Årea de carga de archivos */
        .file-upload {
            border: 3px dashed #ff69b4;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(255, 20, 147, 0.1) 100%);
        }

        .file-upload:hover {
            border-color: #ff1493;
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(255, 20, 147, 0.2) 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.2);
        }

        .upload-icon {
            font-size: 4rem;
            color: #ff69b4;
            margin-bottom: 15px;
            display: block;
        }

        .upload-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #d63384;
            margin-bottom: 10px;
        }

        .upload-subtitle {
            color: #6f42c1;
            font-size: 0.95rem;
        }

        #fileInput {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.3);
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #ff1493, #c91365);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.4);
        }

        .upload-btn:active {
            transform: scale(0.98);
        }

        /* Tarjeta de pregunta */
        .question-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 105, 180, 0.1);
            display: none;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .question-text {
            font-size: 1.3rem;
            color: #2c3e50;
            line-height: 1.6;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .answer-text {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
            font-size: 1.1rem;
            color: #155724;
            display: none;
        }

        /* Botones de evaluaci√≥n */
        .evaluation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .eval-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 120px;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }

        .eval-btn small {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .eval-btn.perfect {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.3);
        }

        .eval-btn.correct {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .eval-btn.partial {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }

        .eval-btn.incorrect {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
        }

        .eval-btn.skip {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        .eval-btn.no-recuerdo {
            background: linear-gradient(135deg, #8b0000 0%, #660000 100%);
            box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4);
        }

        .eval-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .eval-btn:active {
            transform: scale(0.98);
        }

        /* Navegaci√≥n */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Bot√≥n de Reinicio */
        .reset-section {
            text-align: center;
            margin: 25px 0;
        }

        .reset-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        .reset-btn:hover {
            background: linear-gradient(135deg, #ff5252, #e53935);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .reset-icon {
            font-size: 1.1rem;
            animation: rotateIcon 2s linear infinite;
        }

        @keyframes rotateIcon {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Barra de progreso */
        .progress-container {
            margin: 20px 0;
            background: rgba(255, 105, 180, 0.2);
            border-radius: 10px;
            padding: 3px;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border-radius: 8px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Modal de reinicio */
        .reset-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .reset-modal-content {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .reset-modal h3 {
            color: #d63384;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .reset-modal p {
            color: #6f42c1;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .reset-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .confirm-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .cancel-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                margin: 5px;
                padding: 15px;
                border-radius: 20px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
            }

            .logo h1 {
                font-size: 2rem;
            }

            .game-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .evaluation-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .eval-btn {
                width: 100%;
                max-width: none;
                padding: 12px 15px;
            }
        }

        /* Utilidades */
        .hidden {
            display: none !important;
        }

        .message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: popupAnimation 0.3s ease;
        }

        @keyframes popupAnimation {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <h1>üéÆ StudyMaster</h1>
            </div>
        </div>

        <!-- Sistema de puntos gamificado -->
        <div class="game-stats">
            <div class="stat-card level">
                <span class="stat-icon">üéØ</span>
                <div class="stat-value" id="levelDisplay">1</div>
                <div class="stat-label">Nivel</div>
            </div>
            <div class="stat-card points">
                <span class="stat-icon">üíé</span>
                <div class="stat-value" id="pointsDisplay">0</div>
                <div class="stat-label">Puntos</div>
            </div>
            <div class="stat-card streak">
                <span class="stat-icon">üî•</span>
                <div class="stat-value" id="streakDisplay">0</div>
                <div class="stat-label">Racha</div>
            </div>
            <div class="stat-card accuracy">
                <span class="stat-icon">üìä</span>
                <div class="stat-value" id="accuracyDisplay">0%</div>
                <div class="stat-label">Precisi√≥n</div>
            </div>
            <div class="stat-card lives">
                <span class="stat-icon">‚ù§Ô∏è</span>
                <div class="stat-value" id="livesDisplay">5</div>
                <div class="stat-label">Vidas</div>
                <div class="lives-visual" id="livesVisual">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
        </div>

        <!-- Bot√≥n de Reinicio -->
        <div class="reset-section">
            <button class="reset-btn" id="resetBtn" onclick="showResetConfirmation()">
                <span class="reset-icon">üîÑ</span>
                <span class="reset-text">Reiniciar Progreso</span>
            </button>
        </div>

        <!-- Barra de progreso -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressFill"></div>
        </div>

        <!-- √Årea de carga de archivos -->
        <div class="file-upload" id="fileUpload">
            <span class="upload-icon">üìö</span>
            <div class="upload-title">Sube tu archivo de estudio</div>
            <div class="upload-subtitle">Arrastra y suelta un archivo .txt o haz clic para seleccionar</div>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÅ Seleccionar Archivo .txt
            </button>
            <input type="file" id="fileInput" accept=".txt" style="display: none;">
        </div>

        <!-- Tarjeta de pregunta -->
        <div class="question-card" id="questionCard">
            <div class="question-header">
                <div class="question-number" id="questionNumber">Pregunta 1 de 10</div>
            </div>
            <div class="question-text" id="questionText">
                <!-- La pregunta se mostrar√° aqu√≠ -->
            </div>
            <div class="answer-text" id="answerText">
                <!-- La respuesta se mostrar√° aqu√≠ -->
            </div>
            
            <div class="evaluation-buttons" id="evaluationButtons" style="display: none;">
                <button class="eval-btn perfect" onclick="evaluateAnswer('perfect')">
                    ‚≠ê Perfect
                    <small>+50 pts</small>
                </button>
                <button class="eval-btn correct" onclick="evaluateAnswer(true)">
                    ‚úÖ Correcto
                    <small>+20 pts</small>
                </button>
                <button class="eval-btn partial" onclick="evaluateAnswer('partial')">
                    ‚ö° Parcial
                    <small>+10 pts</small>
                </button>
                <button class="eval-btn incorrect" onclick="evaluateAnswer(false)">
                    ‚ùå Incorrecto
                    <small>-10 pts</small>
                </button>
                <button class="eval-btn skip" onclick="evaluateAnswer('skip')">
                    ‚è≠Ô∏è Saltar
                    <small>-5 pts</small>
                </button>
                <button class="eval-btn no-recuerdo" onclick="evaluateAnswer('no_recuerdo')">
                    üòµ No Recuerdo
                    <small>-50 pts</small>
                </button>
            </div>

            <div class="navigation">
                <button class="nav-btn" id="showAnswerBtn" onclick="showAnswer()">
                    üëÅÔ∏è Ver Respuesta
                </button>
                <button class="nav-btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">
                    ‚û°Ô∏è Siguiente
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables del juego
        let gameData = {
            level: 1,
            points: 0,
            experience: 0,
            streak: 0,
            maxStreak: 0,
            lives: 5,
            maxLives: 5,
            combo: 1,
            comboCount: 0,
            maxCombo: 0,
            totalQuestions: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            partialAnswers: 0,
            perfectAnswers: 0,
            skippedAnswers: 0,
            achievements: [],
            sessionStartTime: null
        };

        let questions = [];
        let currentIndex = 0;
        let answerVisible = false;
        let isProcessingFile = false;
        let questionEvaluated = false;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadGameData();
            updateGameStats();
            setupFileUpload();
            autoLoadQuestions(); // Cargar preguntas autom√°ticamente
        });

        // Sistema de archivos
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const fileUpload = document.getElementById('fileUpload');

            console.log('üîß Configurando subida de archivos...');
            console.log('fileInput:', fileInput);
            console.log('fileUpload:', fileUpload);

            if (!fileInput || !fileUpload) {
                console.error('‚ùå No se encontraron los elementos de archivo');
                return;
            }

            fileUpload.addEventListener('click', (e) => {
                console.log('üìÅ Click en √°rea de subida');
                isProcessingFile = false; // Resetear para permitir nueva carga
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                console.log('üìÑ Archivo seleccionado:', e.target.files);
                isProcessingFile = false; // Resetear antes del procesamiento
                handleFileSelect(e);
            });
            
            // Drag & Drop
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.style.transform = 'translateY(-3px) scale(1.02)';
            });
            
            fileUpload.addEventListener('dragleave', () => {
                fileUpload.style.transform = '';
            });
            
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.style.transform = '';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        // Cargar autom√°ticamente el archivo estudioBD.txt
        function autoLoadQuestions() {
            console.log('üîÑ Cargando preguntas autom√°ticamente...');
            
            // Intentar cargar el archivo estudioBD.txt usando fetch
            fetch('./estudioBD.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No se pudo cargar estudioBD.txt');
                    }
                    return response.text();
                })
                .then(content => {
                    console.log('‚úÖ Archivo estudioBD.txt cargado exitosamente');
                    console.log('üìÑ Contenido:', content.substring(0, 100) + '...');
                    
                    questions = parseQuestions(content);
                    console.log('‚ùì Preguntas parseadas:', questions.length);
                    
                    if (questions.length > 0) {
                        // Ocultar √°rea de carga y mostrar bot√≥n para empezar
                        document.getElementById('fileUpload').style.display = 'none';
                        showStartButton();
                    } else {
                        console.log('‚ö†Ô∏è No se encontraron preguntas v√°lidas, mostrando carga manual');
                    }
                })
                .catch(error => {
                    console.log('‚ùå Error cargando archivo autom√°tico:', error);
                    console.log('üìÅ Mostrando interfaz de carga manual');
                    // Si falla la carga autom√°tica, mostrar interfaz normal
                });
        }

        // Mostrar bot√≥n para iniciar sesi√≥n de estudio
        function showStartButton() {
            const fileUpload = document.getElementById('fileUpload');
            fileUpload.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 1.5rem; margin-bottom: 20px;">üìö ${questions.length} preguntas cargadas</div>
                    <div style="margin-bottom: 30px; color: #666;">Base de Datos - Estudiando</div>
                    <button onclick="startStudySession()" style="
                        background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 1.2rem;
                        font-weight: bold;
                        cursor: pointer;
                        box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px) scale(1.05)'" 
                       onmouseout="this.style.transform='translateY(0) scale(1)'">
                        üöÄ ¬°Comenzar Estudio!
                    </button>
                    <div style="margin-top: 20px;">
                        <button onclick="showManualUpload()" style="
                            background: transparent;
                            color: #666;
                            border: 2px dashed #ddd;
                            padding: 10px 20px;
                            border-radius: 15px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">
                            üìÅ Cargar otro archivo
                        </button>
                    </div>
                </div>
            `;
            fileUpload.style.display = 'block';
        }

        // Mostrar interfaz de carga manual
        function showManualUpload() {
            location.reload(); // Recargar para mostrar interfaz original
        }

        function handleFileSelect(event) {
            console.log('üìÇ HandleFileSelect ejecutado');
            console.log('event:', event);
            console.log('files:', event.target.files);
            
            const file = event.target.files[0];
            if (file) {
                console.log('üìÑ Archivo encontrado:', file.name, file.size, 'bytes');
                handleFile(file);
            } else {
                console.log('‚ùå No hay archivo seleccionado');
            }
        }

        function handleFile(file) {
            console.log('üîç Procesando archivo:', file.name);
            
            // Evitar procesamiento doble
            if (isProcessingFile) {
                console.log('‚ö†Ô∏è Ya se est√° procesando un archivo, ignorando...');
                return;
            }
            
            if (!file.name.endsWith('.txt')) {
                console.log('‚ùå Archivo no es .txt');
                showMessage('‚ùå Por favor selecciona un archivo .txt', 'error');
                isProcessingFile = false; // Resetear si archivo inv√°lido
                return;
            }

            console.log('‚úÖ Archivo .txt v√°lido, leyendo contenido...');
            isProcessingFile = true; // Marcar como en proceso
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('üìñ Contenido le√≠do, longitud:', e.target.result.length);
                const content = e.target.result;
                questions = parseQuestions(content);
                console.log('‚ùì Preguntas parseadas:', questions.length);
                
                if (questions.length > 0) {
                    startStudySession();
                } else {
                    isProcessingFile = false; // Resetear si no hay preguntas
                }
            };
            
            reader.onerror = function(e) {
                console.error('‚ùå Error leyendo archivo:', e);
                showMessage('‚ùå Error leyendo el archivo', 'error');
                isProcessingFile = false; // Resetear en caso de error
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function parseQuestions(text) {
            console.log('üîß Parseando texto...');
            
            if (!text || text.trim().length === 0) {
                console.log('‚ùå Texto vac√≠o');
                showMessage('‚ùå El archivo est√° vac√≠o', 'error');
                return [];
            }

            // Dividir por l√≠neas y limpiar
            const lines = text.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
            console.log('üìù L√≠neas encontradas:', lines.length);
            console.log('Primeras 5 l√≠neas:', lines.slice(0, 5));
            
            const parsedQuestions = [];
            
            // Intentar diferentes m√©todos de parseo
            if (lines.length % 2 === 0) {
                // M√©todo 1: Pregunta-respuesta alternadas
                for (let i = 0; i < lines.length; i += 2) {
                    if (i + 1 < lines.length) {
                        parsedQuestions.push({
                            question: lines[i],
                            answer: lines[i + 1]
                        });
                    }
                }
            } else {
                // M√©todo 2: Buscar patrones de pregunta (con ?)
                let currentQuestion = '';
                let currentAnswer = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    if (line.includes('?') || line.toLowerCase().startsWith('qu√©') || 
                        line.toLowerCase().startsWith('cu√°l') || line.toLowerCase().startsWith('c√≥mo')) {
                        // Es una pregunta
                        if (currentQuestion && currentAnswer) {
                            parsedQuestions.push({
                                question: currentQuestion,
                                answer: currentAnswer
                            });
                        }
                        currentQuestion = line;
                        currentAnswer = '';
                    } else {
                        // Es una respuesta
                        if (currentAnswer) {
                            currentAnswer += ' ' + line;
                        } else {
                            currentAnswer = line;
                        }
                    }
                }
                
                // Agregar la √∫ltima pregunta-respuesta
                if (currentQuestion && currentAnswer) {
                    parsedQuestions.push({
                        question: currentQuestion,
                        answer: currentAnswer
                    });
                }
            }
            
            console.log('‚úÖ Preguntas parseadas:', parsedQuestions.length);
            if (parsedQuestions.length === 0) {
                showMessage('‚ùå No se encontraron preguntas v√°lidas en el archivo', 'error');
            }
            
            return parsedQuestions;
        }

        function startStudySession() {
            if (questions.length === 0) {
                showMessage('‚ùå No se encontraron preguntas v√°lidas', 'error');
                isProcessingFile = false; // Resetear si no hay preguntas
                return;
            }

            gameData.sessionStartTime = new Date();
            currentIndex = 0;
            answerVisible = false;
            isProcessingFile = false; // Procesamiento completado exitosamente
            
            document.getElementById('fileUpload').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('questionCard').style.display = 'block';
            
            showQuestion();
            showMessage(`üìö ¬°${questions.length} preguntas cargadas!`, 'success');
            
            // Resetear input para evitar eventos duplicados
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
        }

        function showQuestion() {
            if (currentIndex >= questions.length) {
                endSession();
                return;
            }

            const question = questions[currentIndex];
            document.getElementById('questionNumber').textContent = `Pregunta ${currentIndex + 1} de ${questions.length}`;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('answerText').style.display = 'none';
            document.getElementById('evaluationButtons').style.display = 'none';
            document.getElementById('showAnswerBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            
            answerVisible = false;
            questionEvaluated = false; // Resetear para nueva pregunta
            updateProgress();
        }

        function showAnswer() {
            const question = questions[currentIndex];
            document.getElementById('answerText').textContent = question.answer;
            document.getElementById('answerText').style.display = 'block';
            document.getElementById('evaluationButtons').style.display = 'flex';
            document.getElementById('showAnswerBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
            
            answerVisible = true;
        }

        function evaluateAnswer(evaluation) {
            // Prevenir evaluaciones m√∫ltiples de la misma pregunta
            if (questionEvaluated) {
                showMessage('‚ö†Ô∏è Esta pregunta ya fue evaluada', 'warning');
                return;
            }
            
            // Validar que la respuesta est√© visible antes de evaluar
            if (!answerVisible) {
                showMessage('‚ùå Primero debes ver la respuesta', 'error');
                return;
            }
            
            let basePoints = 0;
            let experience = 0;
            let message = '';
            
            // Sistema progresivo: los puntos aumentan con el nivel
            const levelMultiplier = 1 + (gameData.level - 1) * 0.2; // +20% por nivel

            switch(evaluation) {
                case 'perfect':
                    basePoints = Math.floor(50 * levelMultiplier);
                    experience = Math.floor(25 * levelMultiplier);
                    gameData.perfectAnswers++;
                    gameData.streak++;
                    gameData.comboCount++;
                    message = `Perfect +${basePoints} pts ‚≠ê`;
                    break;
                    
                case true:
                    basePoints = Math.floor(20 * levelMultiplier);
                    experience = Math.floor(10 * levelMultiplier);
                    gameData.correctAnswers++;
                    gameData.streak++;
                    gameData.comboCount++;
                    message = `Correcto +${basePoints} pts ‚úÖ`;
                    break;
                    
                case 'partial':
                    basePoints = Math.floor(10 * levelMultiplier);
                    experience = Math.floor(5 * levelMultiplier);
                    gameData.partialAnswers++;
                    gameData.streak++;
                    gameData.comboCount++;
                    message = `Parcial +${basePoints} pts ‚ö°`;
                    break;
                    
                case false:
                    basePoints = -10;
                    experience = 0;
                    gameData.incorrectAnswers++;
                    gameData.streak = 0;
                    gameData.comboCount = 0; // Romper combo
                    gameData.lives--; // Perder vida
                    message = `Incorrecto -10 pts üò¢ (Vida perdida)`;
                    break;
                    
                case 'skip':
                    basePoints = -5;
                    experience = 0;
                    gameData.skippedAnswers++;
                    gameData.streak = Math.max(0, gameData.streak - 1);
                    gameData.comboCount = 0; // Romper combo
                    message = `Saltado -5 pts ‚è≠Ô∏è`;
                    break;
                    
                case 'no_recuerdo':
                    basePoints = -50;
                    experience = 0;
                    gameData.incorrectAnswers++;
                    gameData.streak = 0;
                    gameData.comboCount = 0; // Romper combo
                    gameData.lives -= 2; // Perder 2 vidas por no recordar
                    message = `No Recuerdo -50 pts üòµ (2 Vidas perdidas)`;
                    break;
            }

            // Aplicar multiplicador de combo para respuestas positivas
            let finalPoints = basePoints;
            if (basePoints > 0 && gameData.comboCount > 1) {
                const comboMultiplier = Math.min(1 + (gameData.comboCount * 0.1), 3); // M√°ximo x3
                finalPoints = Math.floor(basePoints * comboMultiplier);
                message += ` (Combo x${comboMultiplier.toFixed(1)})`;
            }

            // Asegurar que los puntos no sean negativos
            gameData.points = Math.max(0, gameData.points + finalPoints);
            gameData.experience += experience;
            gameData.totalQuestions++;
            gameData.maxStreak = Math.max(gameData.maxStreak, gameData.streak);
            gameData.maxCombo = Math.max(gameData.maxCombo, gameData.comboCount);

            // Asegurar que las vidas no sean negativas
            gameData.lives = Math.max(0, gameData.lives);

            // Verificar Game Over
            if (gameData.lives <= 0) {
                showMessage('üíÄ GAME OVER - ¬°No tienes m√°s vidas!', 'error');
                setTimeout(() => {
                    if (confirm('üíÄ GAME OVER\n\n¬øQuieres reiniciar y obtener 5 vidas nuevas?')) {
                        gameData.lives = 5;
                        gameData.points = Math.floor(gameData.points * 0.5); // Perder 50% de puntos
                        showMessage('üîÑ Reiniciado con 5 vidas. Perdiste 50% de tus puntos.', 'info');
                        updateGameStats();
                        saveGameData();
                    } else {
                        endSession();
                        return;
                    }
                }, 1000);
            }

            // Verificar level up
            let experienceNeeded = gameData.level * 50;
            if (gameData.experience >= experienceNeeded) {
                gameData.level++;
                gameData.experience -= experienceNeeded;
                // Recuperar 1 vida al subir de nivel (m√°ximo 5)
                if (gameData.lives < gameData.maxLives) {
                    gameData.lives++;
                    showMessage(`üéâ ¬°Nivel ${gameData.level}! +1 Vida recuperada ‚ù§Ô∏è`, 'success');
                } else {
                    showMessage(`üéâ ¬°Subiste al nivel ${gameData.level}!`, 'success');
                }
            }

            showMessage(message, basePoints >= 0 ? 'success' : 'error');
            
            // Marcar pregunta como evaluada y ocultar botones
            questionEvaluated = true;
            document.getElementById('evaluationButtons').style.display = 'none';
            
            updateGameStats();
            updateComboIndicator();
            saveGameData();
            
            setTimeout(() => {
                nextQuestion();
            }, 1500);
        }

        function nextQuestion() {
            currentIndex++;
            showQuestion();
        }

        function endSession() {
            const totalCorrect = gameData.correctAnswers + gameData.perfectAnswers + gameData.partialAnswers;
            const accuracy = Math.round((totalCorrect / gameData.totalQuestions) * 100);
            
            showMessage(`üéì ¬°Sesi√≥n completada! Precisi√≥n: ${accuracy}%`, 'success');
            
            // Ocultar tarjeta de pregunta y mostrar area de carga
            document.getElementById('questionCard').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('fileUpload').style.display = 'block';
            
            // Reiniciar para nueva sesi√≥n
            questions = [];
            currentIndex = 0;
            isProcessingFile = false; // Permitir cargar nuevo archivo
        }

        function updateGameStats() {
            // Asegurar que los puntos no sean NaN
            const points = isNaN(gameData.points) ? 0 : gameData.points;
            document.getElementById('pointsDisplay').textContent = points.toLocaleString();
            
            document.getElementById('levelDisplay').textContent = gameData.level;
            document.getElementById('streakDisplay').textContent = gameData.streak;
            
            // Actualizar vidas
            document.getElementById('livesDisplay').textContent = gameData.lives;
            
            // Mostrar vidas visualmente
            let livesVisual = '';
            for (let i = 0; i < gameData.maxLives; i++) {
                if (i < gameData.lives) {
                    livesVisual += '‚ù§Ô∏è';
                } else {
                    livesVisual += 'üñ§'; // Coraz√≥n vac√≠o para vidas perdidas
                }
            }
            document.getElementById('livesVisual').textContent = livesVisual;
            
            const totalCorrect = gameData.correctAnswers + gameData.perfectAnswers + gameData.partialAnswers;
            const accuracy = gameData.totalQuestions > 0 ? 
                Math.round((totalCorrect / gameData.totalQuestions) * 100) : 0;
            document.getElementById('accuracyDisplay').textContent = accuracy + '%';
        }

        function updateProgress() {
            if (questions.length === 0) return;
            
            const progress = ((currentIndex + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function updateComboIndicator() {
            const comboIndicator = document.getElementById('comboIndicator');
            const comboMultiplier = document.getElementById('comboMultiplier');
            
            if (gameData.comboCount > 1) {
                const multiplier = Math.min(1 + (gameData.comboCount * 0.1), 3);
                comboIndicator.style.display = 'block';
                comboMultiplier.textContent = multiplier.toFixed(1);
            } else {
                comboIndicator.style.display = 'none';
            }
        }



        function saveGameData() {
            // Validar datos antes de guardar
            if (isNaN(gameData.points)) gameData.points = 0;
            if (isNaN(gameData.experience)) gameData.experience = 0;
            if (isNaN(gameData.level)) gameData.level = 1;
            if (isNaN(gameData.streak)) gameData.streak = 0;
            if (isNaN(gameData.lives)) gameData.lives = 5;
            if (isNaN(gameData.maxLives)) gameData.maxLives = 5;
            
            try {
                localStorage.setItem('studymaster_game_data', JSON.stringify(gameData));
            } catch (e) {
                console.log('Error guardando datos:', e);
            }
        }

        function loadGameData() {
            const saved = localStorage.getItem('studymaster_game_data');
            if (saved) {
                try {
                    const loadedData = JSON.parse(saved);
                    gameData = { ...gameData, ...loadedData };
                    
                    // Validar y corregir valores NaN
                    gameData.points = isNaN(gameData.points) ? 0 : gameData.points;
                    gameData.experience = isNaN(gameData.experience) ? 0 : gameData.experience;
                    gameData.level = isNaN(gameData.level) ? 1 : gameData.level;
                    gameData.streak = isNaN(gameData.streak) ? 0 : gameData.streak;
                    gameData.lives = isNaN(gameData.lives) ? 5 : gameData.lives;
                    gameData.maxLives = isNaN(gameData.maxLives) ? 5 : gameData.maxLives;
                    gameData.comboCount = isNaN(gameData.comboCount) ? 0 : gameData.comboCount;
                } catch (e) {
                    // Si hay error, reiniciar datos
                    gameData.points = 0;
                    gameData.experience = 0;
                    gameData.level = 1;
                }
            }
        }

        // Sistema de Reinicio
        function showResetConfirmation() {
            const modal = document.createElement('div');
            modal.className = 'reset-modal';
            modal.innerHTML = `
                <div class="reset-modal-content">
                    <h3>‚ö†Ô∏è Confirmar Reinicio</h3>
                    <p>¬øEst√°s seguro de que quieres reiniciar todo tu progreso?</p>
                    <p><strong>Se perder√°n:</strong><br>
                    ‚Ä¢ Todos los puntos (${gameData.points})<br>
                    ‚Ä¢ Nivel ${gameData.level} y experiencia<br>
                    ‚Ä¢ Estad√≠sticas y rachas</p>
                    <div class="reset-modal-buttons">
                        <button class="confirm-btn" onclick="confirmReset()">
                            üóëÔ∏è S√≠, Reiniciar
                        </button>
                        <button class="cancel-btn" onclick="cancelReset()">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmReset() {
            // Reiniciar todos los datos
            gameData = {
                level: 1,
                points: 0,
                experience: 0,
                streak: 0,
                maxStreak: 0,
                lives: 5,
                maxLives: 5,
                combo: 1,
                comboCount: 0,
                maxCombo: 0,
                totalQuestions: 0,
                correctAnswers: 0,
                incorrectAnswers: 0,
                partialAnswers: 0,
                perfectAnswers: 0,
                skippedAnswers: 0,
                achievements: [],
                sessionStartTime: new Date()
            };
            
            localStorage.removeItem('studymaster_game_data');
            updateGameStats();
            cancelReset();
            showMessage('üîÑ Progreso reiniciado completamente', 'success');
        }

        function cancelReset() {
            const modal = document.querySelector('.reset-modal');
            if (modal) modal.remove();
        }

        function showMessage(text, type = 'info') {
            const popup = document.createElement('div');
            popup.className = 'message-popup';
            popup.textContent = text;
            
            if (type === 'error') {
                popup.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            } else if (type === 'success') {
                popup.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            }
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 3000);
        }

        // Debug
        function debugGameData() {
            console.log('üîç DEBUG - Estado del juego:', gameData);
        }
        
        window.debugGameData = debugGameData;
    </script>
</body>
</html>